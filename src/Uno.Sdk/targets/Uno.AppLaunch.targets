<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!--
	 This file defines the UnoNotifyAppLaunch target used to notify the DevServer (RemoteControl)
	 when an application has been launched, so that the DevServer can monitor that the launched app
	 connects back in a timely manner.  This is used to detect launch failures and report them to telemetry.
	 
	 This target is intended to be invoked after the application has been built, but before it is launched, by
	 the IDE tooling (e.g. Visual Studio Code, Rider, etc). Is it not required for VisualStudio, which is using
	 a different mechanism to do the same thing. The implementation in this version is in the `AppLaunch` folder
	 of the `Uno.UI.RemoteControl.VS` project.
	 
	 IMPORTANT: This target should only be called with Debug configuration (-c:Debug or -p:Configuration=Debug).
	 It will fail with an error if called with any other configuration (e.g., Release).
	 
	 Other IDEs will call this target by specifying the `UnoRemoteControlPort` property using the following command:
	 
	 ```shell
		 dotnet build <app csproj> -c:Debug -t:UnoNotifyAppLaunch -p:TargetFramework=<tfm to launch> -p:NoBuild=true -restore:false -v:d -noLogo -low -p:UnoIde=<ide info> -p:UnoPlugin=<Uno plugin version> -p:UnoIsDebug=false
	 ```
	 
	 To retrieve the HTTP response content (MVID and target framework info), use -getProperty:
	 
	 ```shell
		 dotnet build <app csproj> -c:Debug -t:UnoNotifyAppLaunch -getProperty:UnoNotifyAppLaunchHttpResponse -p:TargetFramework=<tfm> -p:NoBuild=true -restore:false -p:UnoIde=<ide> -p:UnoPlugin=<version> -p:UnoIsDebug=false
	 ```
	 -->

	<PropertyGroup>
		<UnoNotifyAppLaunchDependsOn>$(UnoNotifyAppLaunchDependsOn);GetTargetPath</UnoNotifyAppLaunchDependsOn>
	</PropertyGroup>

	<UsingTask TaskName="Uno.Sdk.Tasks.UnoNotifyAppLaunchToDevServer_v0"
			AssemblyFile="$(MSBuildThisFileDirectory)netstandard2.0\Uno.Sdk_v0.dll" />
	<Target Name="UnoNotifyAppLaunch"
			DependsOnTargets="$(UnoNotifyAppLaunchDependsOn)"
			Condition="'$(TargetFramework)'!=''">

		<Message Importance="Low"
				 Text="NotifyAppLaunch: TFM=$(TargetFramework)  TargetPath=$(TargetPath)  Configuration=$(Configuration)"/>

		<Error Text="UnoNotifyAppLaunch target should only be called with Debug configuration. Current configuration: $(Configuration)"
			   Condition="'$(Configuration)' != 'Debug'"/>

		<Error Text="UnoRemoteControlPort property must be defined to use UnoNotifyAppLaunch target."
			   Condition="'$(UnoRemoteControlPort)' == ''"/>

		<Error Text="Target assembly file not found: $(TargetPath)"
			   Condition="!Exists('$(TargetPath)')"/>

		<!-- Pass the new properties -->
		<UnoNotifyAppLaunchToDevServer_v0
			Port="$(UnoRemoteControlPort)"
			TargetPath="$(TargetPath)"
			Ide="$(UnoIde)"
			Plugin="$(UnoPlugin)"
			IsDebug="$(UnoIsDebug)">
			<Output TaskParameter="Success" PropertyName="_UnoLaunchSuccess"/>
			<Output TaskParameter="ResponseContent" PropertyName="UnoNotifyAppLaunchHttpResponse"/>
		</UnoNotifyAppLaunchToDevServer_v0>

		<Error Text="Failed to notify devserver for assembly: $(TargetPath)" Importance="High"  Condition="'$(_UnoLaunchSuccess)' != 'True'"/>

		<Message Text="Successfully notified devserver for assembly: $(TargetPath)"
				 Condition="'$(_UnoLaunchSuccess)' == 'True'"/>

		<Message Text="DevServer response: $(UnoNotifyAppLaunchHttpResponse)"
				 Condition="'$(_UnoLaunchSuccess)' == 'True' AND '$(UnoNotifyAppLaunchHttpResponse)' != ''"/>
	</Target>

</Project>
