<Project Sdk="Microsoft.NET.Sdk">
	<PropertyGroup>
		<TargetFrameworks>$(NetPrevious)-android;$(NetPrevious)-ios</TargetFrameworks>
	</PropertyGroup>

	<Import Project="../../targetframework-override.props" />

	<PropertyGroup>
		<SingleProject>true</SingleProject>

		<OutputType>Exe</OutputType>
		<AssemblyName>SamplesApp</AssemblyName>
		<DefineConstants>$(DefineConstants);XAMARIN;HAS_UNO</DefineConstants>
		<IsUnoHead>true</IsUnoHead>

		<RuntimeIdentifier Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)')) == 'ios'">iossimulator-x64</RuntimeIdentifier>

		<!-- Override RuntimeIdentifir specifically for smaller builds -->
		<RuntimeIdentifier Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)'))!=''">$(UnoSampleAppRuntimeIdentifiers)</RuntimeIdentifier>

		<!--
		Required for Catalyst nuget restore to revalidate
		once transitive dependencies have been updated.
		-->
		<NoWarn>$(NoWarn);NU1703;SYSLIB1045</NoWarn>

		<!--
		aab is the default packaging format in net6 API 31.
		We need an APK for deployment on simulators.
		-->
		<AndroidPackageFormat>apk</AndroidPackageFormat>

		<AndroidEnableMultiDex>true</AndroidEnableMultiDex>
	</PropertyGroup>

	<ItemGroup>
		<!-- Shows applied capabilities in a new VS project node -->
		<ProjectCapability Include="DiagnoseCapabilities" />
	</ItemGroup>

	
	<Choose>

		<When Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)'))=='ios'">
			<ItemGroup>
				<PackageReference Include="Uno.Extensions.Logging.OSLog" Version="1.6.0" />
				<PackageReference Include="SkiaSharp.NativeAssets.iOS" />
				<PackageReference Include="Xamarin.TestCloud.Agent" Condition="'$(BuildForTestFlight)'!='true'" />
			</ItemGroup>

			<PropertyGroup>
				<SupportedOSPlatformVersion>10.0</SupportedOSPlatformVersion>
			</PropertyGroup>

			<PropertyGroup Condition="'$(BuildForTestFlight)'=='true'">
				<UseInterpreter>true</UseInterpreter>
				<MtouchInterpreter>all</MtouchInterpreter>

				<CodesignKey>iPhone Distribution</CodesignKey>
				<RuntimeIdentifier>ios-arm64</RuntimeIdentifier>
				<DefineConstants>$(DefineConstants);TESTFLIGHT</DefineConstants>
			</PropertyGroup>
			
			<ItemGroup>
				<BundleResource Include="..\LinkedFiles\WebContent\css\site.css" Link="iOS\Resources\WebContent\css\site.css" />
				<BundleResource Include="..\LinkedFiles\WebContent\index.html" Link="iOS\Resources\WebContent\index.html" />
				<BundleResource Include="..\LinkedFiles\WebContent\js\site.js" Link="iOS\Resources\WebContent\js\site.js" />			
			</ItemGroup>
		</When>

		<When Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)'))=='android'">
			<PropertyGroup>
				<SupportedOSPlatformVersion>10.0</SupportedOSPlatformVersion>
				<AndroidUseAssemblyStore>false</AndroidUseAssemblyStore>
			</PropertyGroup>

			<PropertyGroup Condition="'$(Configuration)'=='Release'">
				<RuntimeIdentifiers>android-x64;android-arm64</RuntimeIdentifiers>
			</PropertyGroup>
			
			<ItemGroup>
				<PackageReference Include="Xamarin.Google.Android.Material" Version="1.4.0.4" />
				<PackageReference Include="Uno.UniversalImageLoader" Version="1.9.36" />
				<PackageReference Include="SkiaSharp.NativeAssets.Android" />
			</ItemGroup>
						
			<ItemGroup>
				<AndroidAsset Include="Assets\sound.mp3" />
				<AndroidAsset Include="Assets\Lottie\4770-lady-and-dove.json" />
				<AndroidAsset Include="Assets\Lottie\4930-checkbox-animation.json" />
				<AndroidAsset Include="Assets\Lottie\lottie-logo.json" />
				<AndroidAsset Include="Assets\Lottie\uno.json" />
				<AndroidAsset Include="Assets\Lottie\LightBulb.json" />				
				<AndroidAsset Include="..\LinkedFiles\WebContent\js\site.js" Link="Android\Assets\WebContent\js\site.js" />
				<AndroidAsset Include="..\LinkedFiles\WebContent\css\site.css" Link="Android\Assets\WebContent\css\site.css" />
				<AndroidAsset Include="..\LinkedFiles\WebContent\index.html" Link="Android\Assets\WebContent\index.html" />
				<AndroidEnvironment Include="Android\environment.conf" />
			</ItemGroup>
		</When>
	</Choose>

	<PropertyGroup>
		<IsUiAutomationMappingEnabled>true</IsUiAutomationMappingEnabled>
	</PropertyGroup>

	<PropertyGroup Condition="'$(Configuration)'=='Debug'">
	  <DefineConstants>$(DefineConstants);DEBUG;TRACE</DefineConstants>
	</PropertyGroup>

	<ItemGroup>
		<PackageReference Include="Microsoft.Graph">
			<Version>3.12.0</Version>
		</PackageReference>
		<PackageReference Include="Microsoft.Identity.Client">
			<Version>4.61.3</Version>
		</PackageReference>

		<PackageReference Include="MSTest.TestFramework" Version="2.1.1" />
		<PackageReference Include="Microsoft.Extensions.Logging.Console" Version="1.1.1" />
		<PackageReference Include="Microsoft.Extensions.Logging.Filter" Version="1.1.1" />
		<PackageReference Include="Uno.Core.Extensions.Logging.Singleton" Version="4.0.0-dev.7" />
		<PackageReference Include="Uno.Fonts.Fluent" />
		<!--<PackageReference Include="Uno.Resizetizer" />-->
	</ItemGroup>

	<ItemGroup>
		<ProjectReference Include="..\..\Uno.Foundation\Uno.Foundation.netcoremobile.csproj" />
		<ProjectReference Include="..\..\Uno.UI\Uno.UI.Skia.csproj" />
		<ProjectReference Include="..\..\Uno.UWP\Uno.netcoremobile.csproj" />
		<ProjectReference Include="..\SamplesApp.Skia\SamplesApp.Skia.csproj" />
		<ProjectReference Include="..\..\Uno.UI.Runtime.Skia.Android\Uno.UI.Runtime.Skia.Android.csproj" Condition="$([MSBuild]::GetTargetPlatformIdentifier('$(TargetFramework)'))=='android'" />
	</ItemGroup>

	<ItemGroup>
	  <Folder Include="Properties\" />
	</ItemGroup>

	<Import Project="..\..\SourceGenerators\sourcegenerators.local.props" />

	<Import Project="..\..\..\build\nuget\uno.winui.single-project.targets" />

	<Target Name="GenerateVersion" 
			BeforeTargets="BeforeBuild;_CompileAppManifest;_GetAndroidPackageName" 
			Condition="'$(GITVERSION_InformationalVersion)'!=''">

		<Exec Command="git rev-list --count HEAD"
              ConsoleToMSBuild="true">
			<Output TaskParameter="ConsoleOutput"
                      PropertyName="_VersionCode" />
		</Exec>

		<PropertyGroup>
			<_VersionCode Condition="$(VersionCodeOffset) != ''">$([MSBuild]::Add($(_VersionCode), $(VersionCodeOffset)))</_VersionCode>

			<ApplicationDisplayVersion>$([System.DateTime]::Now.ToString(`yyMMddHHmm`)).$(_VersionCode)</ApplicationDisplayVersion>
			<ApplicationVersion>$(_VersionCode)</ApplicationVersion>
			<InformationalVersion>$(GITVERSION_InformationalVersion)</InformationalVersion>
		</PropertyGroup>

	</Target>

	<PropertyGroup >
		<!-- Versions -->
		<ApplicationDisplayVersion>1.0</ApplicationDisplayVersion>
		<ApplicationVersion>1</ApplicationVersion>

	</PropertyGroup>


	<Target Name="ReplaceUnoRuntime" AfterTargets="ResolveReferences">

		<ItemGroup>
			<_AssemblyCopyLocalPaths Include="@(ReferenceCopyLocalPaths)" Condition="'%(ReferenceCopyLocalPaths.FusionName)' != '' and '%(ReferenceCopyLocalPaths.FusionName)'=='Uno, Version=255.255.255.255, Culture=neutral, PublicKeyToken=null'" />
			<_AssemblyCopyLocalPaths Include="@(ReferenceCopyLocalPaths)" Condition="'%(ReferenceCopyLocalPaths.FusionName)' != '' and '%(ReferenceCopyLocalPaths.FusionName)'=='Uno.UI.Dispatching, Version=255.255.255.255, Culture=neutral, PublicKeyToken=null'" />

			<!-- Remove them from the files to be copied to the output -->
			<ReferenceCopyLocalPaths Remove="@(_AssemblyCopyLocalPaths)" />

			<_redirectedReferences Include="..\..\Uno.UWP\bin\Uno.netcoremobile\$(Configuration)\$(TargetFramework)\Uno.dll" />
			<_redirectedReferences Include="..\..\Uno.UI.Dispatching\bin\Uno.UI.Dispatching.netcoremobile\$(Configuration)\$(TargetFramework)\Uno.UI.Dispatching.dll" />

			<ReferenceCopyLocalPaths Include="@(_redirectedReferences)" />

			<_UnoWasmBootstrapAssembliesForReferenceCopyLocalPaths
				Include="$(MSBuildProjectDirectory)\..\..\Uno.UWP\bin\Uno.netcoremobile\$(Configuration)\$(TargetFramework)\Uno.dll"/>
			<_UnoWasmBootstrapAssembliesForReferenceCopyLocalPaths
				Include="$(MSBuildProjectDirectory)\..\..\Uno.UI.Dispatching\bin\Uno.UI.Dispatching.netcoremobile\$(Configuration)\$(TargetFramework)\Uno.UI.Dispatching.dll"/>
		</ItemGroup>

	</Target>


</Project>
