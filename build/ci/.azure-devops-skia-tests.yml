parameters:
  vmImage: ''
  vmMacImage: ''
  vmMacImageTest: ''
  vmLinuxImage: ''
  vmLinuxPool: ''
  xCodeRootTest: ''
  xCodeRootBuild: ''
  poolName: ''
  UNO_UWP_BUILD: ''
  XAML_FLAVOR_BUILD: ''

  # Runtime Test Groups
  IOS_RUNTIME_TEST_GROUP_COUNT: 8
  IOS_RUNTIME_TESTS_GROUPS:
  - key: '0'
    value: '01'
  - key: '1'
    value: '02'
  - key: '2'
    value: '03'
  - key: '3'
    value: '04'
  - key: '4'
    value: '05'
  - key: '5'
    value: '06'
  - key: '6'
    value: '07'
  - key: '7'
    value: '08'

  snapshotGroups:
    - 0
    - 1
    - 2

  snapshotGroupCount: 3

jobs:
- template: .azure-devops-package-skia-native-assets.yml
  parameters:
    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}
    macOSImageName: ${{ parameters.vmMacImage }}
    AssetNativeSuffix: '-SamplesApp'

- job: Skia_Tests_Build
  displayName: 'Build Skia Samples App UI Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1
  dependsOn: skia_package_macos_native_build

  pool: ${{ parameters.poolName }}

  variables:
    CombinedConfiguration: Release|Any CPU
    CI_Build: true
    GTK_RUNTIME_URL: https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer/releases/download/2020-07-15/gtk3-runtime-3.24.20-2020-07-15-ts-win64.exe

    # Use pre-defined local nuget cache for restore
    NUGET_PACKAGES: 'C:\NugetPackages'

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - checkout: self
    clean: true

  - template: templates/download-winui-converted-tree.yml

  - template: templates/gitversion.yml
  - template: templates/dotnet-mobile-install-windows.yml
    parameters:
      UnoCheckParameters: '--tfm net9.0-browserwasm --tfm net9.0-desktop'

  - template: templates/nuget-cache.yml
    parameters:
      nugetPackages: $(NUGET_PACKAGES)

  ## Restore skia-macos native assets
  - task: DownloadPipelineArtifact@2
    displayName: Restoring macOS native assets
    inputs:
      artifact: NugetPackages-Artifacts-skia-macos-native-SamplesApp-$(XAML_FLAVOR_BUILD)
      path: $(Build.SourcesDirectory)/src/Uno.UI.Runtime.Skia.MacOS/UnoNativeMac/build/Release

  - powershell: dotnet msbuild src/SamplesApp/SamplesApp.Skia.Gtk/SamplesApp.Skia.Gtk.csproj /r /m /p:UnoTargetFrameworkOverride=net8.0 /p:Configuration=Release /detailedsummary /m /bl:$(build.artifactstagingdirectory)\build-gtk.binlog
    displayName: Build GTK Head

  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)\src\SamplesApp\SamplesApp.Skia.Gtk\bin\Release\net8.0
      ArtifactName: skia-gtk-samples-app-$(XAML_FLAVOR_BUILD)
      ArtifactType: Container

  - powershell: dotnet msbuild src/SamplesApp/UnoIslandsSamplesApp.Skia.WPF/UnoIslandsSamplesApp.Skia.Wpf.csproj /r /m /p:UnoTargetFrameworkOverride=net8.0 /p:Configuration=Release /detailedsummary /m /bl:$(build.artifactstagingdirectory)\build-wpf-islands.binlog
    displayName: Build WPF Islands Head

  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)\src\SamplesApp\UnoIslandsSamplesApp.Skia.WPF\bin\Release\net8.0-windows
      ArtifactName: uno-islands-skia-wpf-samples-app-$(XAML_FLAVOR_BUILD)
      ArtifactType: Container

  - powershell: dotnet publish src/SamplesApp/SamplesApp.Skia.Generic/SamplesApp.Skia.Generic.csproj -c Release -p:UnoTargetFrameworkOverride=net8.0 -f net8.0 /bl:$(build.artifactstagingdirectory)\build-generic.binlog
    displayName: Build Generic Skia Head

  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)\src\SamplesApp\SamplesApp.Skia.Generic\bin\Release\net8.0
      ArtifactName: skia-generic-samples-app-$(XAML_FLAVOR_BUILD)
      ArtifactType: Container

  - powershell: dotnet publish src/SamplesApp/SamplesApp.Skia.WebAssembly.Browser/SamplesApp.Skia.WebAssembly.Browser.csproj -c Release -f net9.0 /bl:$(build.artifactstagingdirectory)\build-skia-wasm-browser.binlog
    displayName: Build Wasm Skia Head

  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)\src\SamplesApp\SamplesApp.Skia.WebAssembly.Browser\bin\Release\net9.0\publish\wwwroot
      ArtifactName: skia-browserwasm-samples-app-$(XAML_FLAVOR_BUILD)
      ArtifactType: Container

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: uitests-ios-skia-build
      ArtifactType: Container


  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: skia-samples-app-binlog
      ArtifactType: Container


- job: Skia_Tests_Build_Apple
  displayName: 'Build Apple Skia Samples App UI Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1
  dependsOn: skia_package_macos_native_build

  pool:
    vmImage: ${{ parameters.vmMacImage }}

  variables:
    CombinedConfiguration: Release|Any CPU
    CI_Build: true
    NUGET_PACKAGES: $(Agent.WorkFolder)/.nuget
    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - checkout: self
    clean: true

  - template: templates/download-winui-converted-tree.yml

  - template: templates/gitversion.yml
  - template: templates/dotnet-mobile-install-mac.yml
    parameters:
      UnoCheckParameters: '--tfm net9.0-ios --tfm net9.0-maccatalyst'

  - template: templates/nuget-cache.yml
    parameters:
      nugetPackages: $(NUGET_PACKAGES)

  ## Restore skia-macos native assets
  - task: DownloadPipelineArtifact@2
    displayName: Restoring macOS native assets
    inputs:
      artifact: NugetPackages-Artifacts-skia-macos-native-SamplesApp-$(XAML_FLAVOR_BUILD)
      path: $(Build.SourcesDirectory)/src/Uno.UI.Runtime.Skia.MacOS/UnoNativeMac/build/Release

  # iOS
  - template: templates/ios-build-select-version.yml
    parameters:
      xCodeRoot: ${{ parameters.xCodeRootBuild }}

  - bash: |
      chmod +x $(build.sourcesdirectory)/build/test-scripts/skia-ios-uitest-build.sh
      $(build.sourcesdirectory)/build/test-scripts/skia-ios-uitest-build.sh
    displayName: Build iOS Skia Head
    env:
      BUILD_SOURCESDIRECTORY: "$(build.sourcesdirectory)"
      BUILD_ARTIFACTSTAGINGDIRECTORY: "$(build.artifactstagingdirectory)"


  - task: CopyFiles@2
    inputs:
      SourceFolder: $(build.sourcesdirectory)/src/SamplesApp/SamplesApp.Skia.netcoremobile/bin/Release/net8.0-ios/iossimulator-x64/SamplesApp.app
      Contents: '**'
      TargetFolder: $(build.artifactstagingdirectory)/SamplesApp.app
      CleanTargetFolder: false
      OverWrite: false
      flattenFolders: false

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: uitests-ios-skia-build
      ArtifactType: Container


  - task: PublishBuildArtifacts@1
    retryCountOnTaskFailure: 3
    condition: always()
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: skia-samples-app-binlog
      ArtifactType: Container

##
## GTK
##

- job: Skia_Gtk_Screenshot_Tests
  displayName: 'Run Skia GTK Snapshot Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmImage }}

  dependsOn: Skia_Tests_Build
  condition: and(succeeded(), eq(variables['UNO_UWP_BUILD'], 'false'))

  variables:
    SamplesAppArtifactName: skia-gtk-samples-app-WinUI
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)
    SnapshotGroupCount: ${{ parameters.snapshotGroupCount }}
    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  strategy:
    matrix:
      ${{ each testGroup in parameters.snapshotGroups }}:
        Group_${{ testGroup }}:
          SNAPSHOT_GROUP: ${{ testGroup }}

  steps:
  - checkout: none
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/gtk-install-windows.yml

  - script: |
        cd $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)
        dotnet SamplesApp.Skia.Gtk.dll --auto-screenshots=$(build.artifactstagingdirectory)/screenshots/skia-gtk-screenshots --total-groups=$(SnapshotGroupCount) --current-group-index=$(SNAPSHOT_GROUP)

    displayName: Run Skia GTK Snapshot Tests

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: uitests-results
      ArtifactType: Container

- job: Skia_Gtk_Runtime_Tests_Build
  displayName: 'Run Skia GTK Runtime Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmImage }}

  strategy:
    matrix:
      GROUP_0:
        UITEST_RUNTIME_TEST_GROUP: 0
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

      GROUP_1:
        UITEST_RUNTIME_TEST_GROUP: 1
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

      GROUP_2:
        UITEST_RUNTIME_TEST_GROUP: 2
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

  dependsOn: Skia_Tests_Build

  variables:
    SamplesAppArtifactName: skia-gtk-samples-app-$(XAML_FLAVOR_BUILD)
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)
    UnoEnableHRuntimeTests: true

    CI_Build: true

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:

  - template: templates/download-winui-converted-tree.yml

  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml
  - template: templates/gtk-install-windows.yml

  - script: |
      # Build source generators for hot reload runtime tests
      # Used to build the hot reload test secondary app during runtime tests
      cd $(build.sourcesdirectory)/src/SourceGenerators/Uno.UI.Tasks
      dotnet build -c Debug
      cd $(build.sourcesdirectory)/src/SourceGenerators/Uno.UI.SourceGenerators
      dotnet build -c Debug
      cd $(build.sourcesdirectory)/src/Uno.UI.RemoteControl.Host
      dotnet build -c Debug
    displayName: Build HR dependencies

  # We need just the .NET 8 runtime (not the SDK).
  # Building with .NET 9 SDK is fine, but running the app when the TFM is net8.0 requires the .NET 8 runtime
  - task: UseDotNet@2
    inputs:
      packageType: 'runtime'
      version: '8.x'

  - script: |
        cd $(SamplesAppArtifactPath)
        dotnet SamplesApp.Skia.Gtk.dll --runtime-tests=$(build.sourcesdirectory)/build/skia-gtk-runtime-tests-results.xml

    displayName: Run Skia GTK $(XAML_FLAVOR_BUILD) Runtime Tests
    env:
      UnoEnableHRuntimeTests: $(UnoEnableHRuntimeTests)
      SamplesAppArtifactPath: $(SamplesAppArtifactPath)
      SamplesAppArtifactName: $(SamplesAppArtifactName)

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Skia GTK $(XAML_FLAVOR_BUILD) Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/skia-gtk-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

##
## WPF
##

- job: Skia_Windows_Screenshot_Tests
  displayName: 'Run Skia Windows Snapshot Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmImage }}

  dependsOn: Skia_Tests_Build
  condition: and(succeeded(), eq(variables['UNO_UWP_BUILD'], 'false'))

  variables:
    SamplesAppArtifactName: skia-generic-samples-app-WinUI
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - checkout: none
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - script: |
        cd $(SamplesAppArtifactPath)
        dotnet SamplesApp.Skia.Generic.dll --auto-screenshots=$(build.artifactstagingdirectory)/screenshots/skia-windows-screenshots

    displayName: Run Skia Windows Snapshot Tests

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: uitests-results
      ArtifactType: Container

- job: Skia_Windows_Runtime_Tests_Build
  displayName: 'Run Skia Windows Runtime Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmImage }}

  dependsOn: Skia_Tests_Build

  variables:
    SamplesAppArtifactName: skia-generic-samples-app-$(XAML_FLAVOR_BUILD)
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml

  - script: |
        cd $(SamplesAppArtifactPath)
        dotnet SamplesApp.Skia.Generic.dll --runtime-tests=$(build.sourcesdirectory)/build/skia-windows-runtime-tests-results.xml

    displayName: Run Skia Windows $(XAML_FLAVOR_BUILD) Runtime Tests

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Skia Windows $(XAML_FLAVOR_BUILD) Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/skia-windows-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

- job: Uno_Islands_Skia_Wpf_Runtime_Tests_Build
  displayName: 'Run Uno Islands Skia WPF Runtime Tests'
  timeoutInMinutes: 45
  cancelTimeoutInMinutes: 1
  condition: and(succeeded(), eq(variables['UNO_UWP_BUILD'], 'false'))
  pool:
    vmImage: ${{ parameters.vmImage }}

  dependsOn: Skia_Tests_Build

  variables:
    SamplesAppArtifactName: uno-islands-skia-wpf-samples-app-WinUI
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml

  - script: |
        cd $(SamplesAppArtifactPath)
        dotnet UnoIslandsSamplesApp.Skia.Wpf.dll --runtime-tests=$(build.sourcesdirectory)/build/uno-islands-skia-wpf-runtime-tests-results.xml

    displayName: Run Uno Islands Skia WPF Runtime Tests

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Uno Islands Skia WPF Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/uno-islands-skia-wpf-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

##
## X11
##

- job: Skia_Linux_Screenshot_Tests
  displayName: 'Run Skia Linux Snapshot Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmLinuxImage }}

  dependsOn: Skia_Tests_Build
  condition: and(succeeded(), eq(variables['UNO_UWP_BUILD'], 'false'))

  variables:
    SamplesAppArtifactName: skia-generic-samples-app-WinUI
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)
    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - checkout: none
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/linux-install-deps.yml

  - script: |
        cd $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)
        xvfb-run --auto-servernum --server-args='-screen 0 1280x1024x24' sh -c '{ fluxbox & } ; dotnet SamplesApp.Skia.Generic.dll --auto-screenshots=$(build.artifactstagingdirectory)/screenshots/skia-linux-screenshots'

    displayName: Run Skia Linux Snapshot Tests

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: uitests-results
      ArtifactType: Container

- job: Skia_Linux_Runtime_Tests_Build
  displayName: 'Run Skia Linux Runtime Tests'
  timeoutInMinutes: 60
  cancelTimeoutInMinutes: 1

  pool:
    vmImage: ${{ parameters.vmLinuxImage }}

  dependsOn: Skia_Tests_Build

  variables:
    SamplesAppArtifactName: skia-generic-samples-app-$(XAML_FLAVOR_BUILD)
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:

  - template: templates/download-winui-converted-tree.yml

  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml
  - template: templates/linux-install-deps.yml

  - script: |
        cd $(SamplesAppArtifactPath)
        xvfb-run --auto-servernum --server-args='-screen 0 1280x1024x24' sh -c '{ fluxbox & } ; dotnet SamplesApp.Skia.Generic.dll --runtime-tests=$(build.sourcesdirectory)/build/skia-linux-runtime-tests-results.xml'

    displayName: Run Skia  $(XAML_FLAVOR_BUILD) Runtime Tests
    env:
      SamplesAppArtifactPath: $(SamplesAppArtifactPath)
      SamplesAppArtifactName: $(SamplesAppArtifactName)

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Skia Linux $(XAML_FLAVOR_BUILD) Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/skia-linux-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

- job: Skia_macos_Runtime_Tests_Build
  displayName: 'Run Skia macOS Runtime Tests'
  timeoutInMinutes: 60

  pool:
    vmImage: ${{ parameters.vmMacImage }}

  dependsOn: Skia_Tests_Build

  variables:
    SamplesAppArtifactName: skia-generic-samples-app-$(XAML_FLAVOR_BUILD)
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:

  - template: templates/download-winui-converted-tree.yml

  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml

  - script: |
        cd $(SamplesAppArtifactPath)
        dotnet SamplesApp.Skia.Generic.dll --runtime-tests=$(build.sourcesdirectory)/build/skia-macos-runtime-tests-results.xml

    displayName: Run Skia  $(XAML_FLAVOR_BUILD) Runtime Tests
    env:
      SamplesAppArtifactPath: $(SamplesAppArtifactPath)
      SamplesAppArtifactName: $(SamplesAppArtifactName)

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Skia macOS $(XAML_FLAVOR_BUILD) Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/skia-macos-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

##
## Skia WebAssembly Browser
##

- job: Skia_Browser_Runtime_Tests_Build
  displayName: 'Run Skia Browser Runtime Tests'
  timeoutInMinutes: 60

  pool:
    vmImage: ${{ parameters.vmLinuxImage }}

  dependsOn: Skia_Tests_Build

  strategy:
    matrix:
      GROUP_0:
        UITEST_RUNTIME_TEST_GROUP: 0
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

      GROUP_1:
        UITEST_RUNTIME_TEST_GROUP: 1
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

      GROUP_2:
        UITEST_RUNTIME_TEST_GROUP: 2
        UITEST_RUNTIME_TEST_GROUP_COUNT: 3

  variables:
    SamplesAppArtifactName: skia-browserwasm-samples-app-$(XAML_FLAVOR_BUILD)
    SamplesAppArtifactPath: $(build.sourcesdirectory)/build/$(SamplesAppArtifactName)

    UNO_UWP_BUILD: ${{ parameters.UNO_UWP_BUILD }}
    XAML_FLAVOR_BUILD: ${{ parameters.XAML_FLAVOR_BUILD }}

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
        artifactName: $(SamplesAppArtifactName)
        downloadPath: '$(build.sourcesdirectory)/build'

  - template: templates/dotnet-install.yml

  - template: templates/linux-install-deps.yml

  - bash: |
        set -euo pipefail
        set -x
        # We use google-chrome instead of chromium-browser because ubuntu uses snap
        # for the chromium package, and snapd isn't available in CI
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get update
        sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
    displayName: Install chrome

  - bash: build/test-scripts/wasm-run-skia-runtime-tests.sh
    displayName: Run Skia Browser $(XAML_FLAVOR_BUILD) Runtime Tests

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testRunTitle: 'Skia Browser $(XAML_FLAVOR_BUILD) Runtime Tests'
      testResultsFormat: 'NUnit'
      testResultsFiles: '$(build.sourcesdirectory)/build/skia-browserwasm-runtime-tests-results.xml'
      failTaskOnFailedTests: true
      failTaskOnMissingResultsFile: true

##
## iOS Skia
##

##
## Runtime tests
##
- ${{ each RuntimeTestGroup in parameters.IOS_RUNTIME_TESTS_GROUPS }}:
  - template: .azure-devops-ios-tests-run.yml
    parameters:
      nugetPackages: $(NUGET_PACKAGES)
      JobName: 'Skia_iOS_Runtime_Tests_group_${{ RuntimeTestGroup.value }}'
      JobDisplayName: 'Skia iOS Runtime Tests ${{ RuntimeTestGroup.value }}'
      JobTimeoutInMinutes: 90
      vmImage: ${{ parameters.vmMacImageTest }}
      SamplesAppArtifactName: 'uitests-ios-skia-build'
      UITEST_SNAPSHOTS_ONLY: false
      UITEST_TEST_TIMEOUT: '90m'
      UITEST_AUTOMATED_GROUP: RuntimeTests
      UITEST_RUNTIME_TEST_GROUP: ${{ RuntimeTestGroup.key }}
      UITEST_RUNTIME_TEST_GROUP_COUNT: ${{ parameters.UITEST_RUNTIME_TEST_GROUP_COUNT }}
      UITEST_ALLOW_RERUN: 'false'
      UITEST_VARIANT: 'skia'
      xCodeRoot: ${{ parameters.xCodeRootTest }}
      dependsOn:
        - Skia_Tests_Build_Apple
